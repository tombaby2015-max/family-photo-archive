<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Фотоальбом</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f6f7;
      color: #222;
    }

    /* ===== ШАПКА ===== */
    .album-header {
      position: relative;
      background-size: cover;
      background-position: center;
      padding: 24px;
      color: #fff;
    }

    .album-header::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,.45);
    }

    .album-header-inner {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .back-btn {
      color: #fff;
      text-decoration: none;
      font-size: 16px;
    }

    .album-title {
      font-size: 20px;
      font-weight: 600;
      text-align: center;
      flex: 1;
    }

    .add-btn {
      font-size: 14px;
      color: #fff;
      cursor: pointer;
    }

    /* ===== СЕТКА ===== */
    .photos {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
    }

    .photo {
      cursor: pointer;
    }

    .photo img {
      width: 100%;
      border-radius: 8px;
      object-fit: cover;
    }

    /* ===== ПРОСМОТР ===== */
    .viewer {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .viewer img {
      max-width: 80%;
      max-height: 80%;
    }

    .nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 40px;
      color: #fff;
      cursor: pointer;
      user-select: none;
    }

    .nav.left { left: 30px; }
    .nav.right { right: 30px; }

    .close {
      position: absolute;
      top: 30px;
      right: 30px;
      font-size: 28px;
      cursor: pointer;
    }

    .actions {
      position: absolute;
      bottom: 40px;
      display: flex;
      gap: 20px;
    }

    .actions a,
    .actions button {
      background: none;
      border: 1px solid #fff;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="album-header" id="header">
  <div class="album-header-inner">
    <a class="back-btn" href="index.html">← Назад</a>
    <div class="album-title" id="albumTitle"></div>
    <div class="add-btn">Добавить фото</div>
  </div>
</div>

<div class="photos" id="photos"></div>

<div class="viewer" id="viewer">
  <div class="nav left" onclick="prev()">‹</div>
  <img id="viewerImg">
  <div class="nav right" onclick="next()">›</div>
  <div class="close" onclick="closeViewer()">✕</div>
  <div class="actions">
    <a id="downloadBtn" download>Скачать</a>
    <button id="deleteBtn" onclick="deletePhoto()">Удалить</button>
  </div>
</div>

<script>
const API = 'https://family-photos-worker.belovolov-email.workers.dev/api';
const params = new URLSearchParams(location.search);
const albumId = Number(params.get('id'));
const title = params.get('title');

let photos = [];
let index = 0;

document.getElementById('albumTitle').textContent = title;

async function loadAlbum() {
  const res = await fetch(API + '/get-albums');
  const data = await res.json();
  const album = data.albums.find(a => a.id === albumId);

  if (!album) return;

  photos = album.photos;

  if (album.cover_photo) {
    document.getElementById('header').style.backgroundImage =
      `url(${API.replace('/api','')}/api/get-photo?file_id=${album.cover_photo})`;
  }

  renderPhotos();
}

function renderPhotos() {
  const box = document.getElementById('photos');
  box.innerHTML = '';

  photos.forEach((p, i) => {
    const d = document.createElement('div');
    d.className = 'photo';
    d.innerHTML = `<img src="${API.replace('/api','')}/api/get-photo?file_id=${p.file_id}">`;
    d.onclick = () => open(i);
    box.appendChild(d);
  });
}

function open(i) {
  index = i;
  document.getElementById('viewer').style.display = 'flex';
  updateViewer();
}

function updateViewer() {
  const p = photos[index];
  const url = API.replace('/api','') + '/api/get-photo?file_id=' + p.file_id;
  document.getElementById('viewerImg').src = url;
  document.getElementById('downloadBtn').href = url;
}

function closeViewer() {
  document.getElementById('viewer').style.display = 'none';
}

function prev() {
  if (index > 0) { index--; updateViewer(); }
}

function next() {
  if (index < photos.length - 1) { index++; updateViewer(); }
}

async function deletePhoto() {
  if (!confirm('Удалить фото только с сайта?')) return;

  await fetch(API + '/delete-photo', {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      albumId,
      file_id: photos[index].file_id
    })
  });

  photos.splice(index, 1);
  closeViewer();
  renderPhotos();
}

loadAlbum();
</script>

</body>
</html>
